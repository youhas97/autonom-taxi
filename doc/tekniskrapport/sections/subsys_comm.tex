\documentclass[tekniskrapport/tech.tex]{subfiles}

\begin{document}

\section{Kommunikationsmodul}
Kommunikationsmodulen styr bilen och kommunicerar med fjärrklienten.
Sensorvärden från sensormodulen tolkas av kommunikationsmodulen som därefter
skickar felvärden till styrmodulen.

\subsection{Funktion}
Kommunikationsmodulen har tre huvudsakliga uppgifter; bildbehandling,
kommunicera med fjärrklienten och kontrollera taxin autonomt.

\paragraph{Bildbehandling} skall utföras av kommunikationsmodulen för att
avgöra bilens position i vägfilen och upptäcka stopplinjer. Med hjälp av
kamerans bilder på vägen skapas ett felvärde som kan användas för att justera
taxins riktning.

\paragraph{Kommunikation med fjärrklienten} sköts av kommunikationsmodulen för
att skicka sensorvärden och annan relevant information. Modulen skall även ta
emot ett uppdrag som har skapats utifrån en karta och destination som
användaren har matat in via fjärrklienten.

\paragraph{Autonomitet} utförs av kommunikationsmodulen för att utföra
uppdraget. Kommunikationsmodulen hämtar sensordata från sensormodulen och
bildbehandlar kamerabilderna för att utföra beslut i realtid. Besluten kommer
därefter att översättas till felvärden som skickas till styrmodulen.

\subsection{Hårdvaruimplementation} 
Kommunikationsmodulen kommer att implementeras med hjälp av en Raspberry Pi 3,
där en WLAN-komponent redan finns integrerat. Kameran kommer att kopplas direkt
till kameraporten som finns på Raspberry Pi-kortet. GPIO-pinnarna kommer att
användas för att ansluta till övriga moduler.  Eftersom SPI-protokollet ska
användas, kommer GPIO-portar för de signalerna som protokollet kräver användas.
Det kommer att finnas nivåskiftare som skiftar spänningen på signalerna som går
mellan kommunikationsmodulen och mikrokontrollerna. Ett kretsschema för modulen
finns i bilaga \ref{cdiag:comm}.

\subsection{Mjukvaruimplementation}
Kommunikationsmodulens program är skriven i både C och C++. Bildbehandlingen är
skriven i C++ medan resten av programmet är implementerad med C.  Programmet
består av tre trådar; en huvudtråd som hanterar uppdrag och bildbehandlar, samt
en tråd som sköter kommunikation via SPI och en som svarar på kommandon från
fjärrklienten via TCP/IP. SPI:n och servern sköts i separata trådar eftersom de
blockerar och väntar mycket.

\paragraph{Huvudtråden} kommer att starta en TCP/IP-server för att lyssna på
kommandon från fjärrklienten. Tråden kommer köra en while loop där den först
accepterar inkommande anslutningar och agerar utefter protokollet som är
specificerat i sektion \ref{sec:wlproto}. Därefter kommer den hantera uppdraget
och eventuellt bildbehandla. Därefter uppdatera felvärde som ska skickas till
styrmodulen.

\paragraph{SPI-bussen} kommer hanteras av en dedikerad tråd. Den skall
kontinuerligt hämta värden från sensormodulen oberoende av andra trådar. När
bildbehandlingen är färdig med nästa bild skall felvärdet skickas till
styrmodulen. Detta sker i en separat tråd för att inte fördröja
bildbehandlingen i väntan på bussen.

\subsubsection{Uppdrag} \label{sec:comm-mission}
För att utföra uppdraget kommer en kö av kommandon tas emot från fjärrklienten.
När uppdraget börjar kör taxin framåt och följer filen med hjälp av
bildbehandling och reglering. Inför varje stopplinje tas ett kommando från kön
och utförs. Om ett hinder upptäcks under uppdraget kommer bilen att stanna
tills hindret har försvunnit eller eventuellt passera hindret. När ett visst
antal stopplinjer har passerats och kön är tom är uppdraget avklarat. Nedan är
en lista av alla möjliga kommandon hur de utförs.
\begin{labeling}{wwww}
    \item[\commIgnore] Kör förbi stopplinjen utan att stanna.
    \item[\commStop] Stanna framför stopplinjen, fortsätt efter några sekunder
    om kön inte är tom.
    \item[\commPark] Parkera i fickan till höger efter stopplinjen, lämna
    parkeringen och fortsätt efter några sekunder om kön inte är tom.
    \item[\commEnter] Sväng höger in i rondellen och hitta rondellens körfil.
    \item[\commContinue] Kör förbi stopplinje och håll till vänster.
    \item[\commExit] Sväng höger ut ur rondellen och hitta körfilen.
\end{labeling}

\end{document}
