\documentclass[designspec/spec.tex]{subfiles}

% Detta avsnitt bör innehålla:
%
%   -En beskrivning av hur processorerna kommunicerar med varandra (gäller även
%   kommunikation med PC:n om Blåtand används), protokoll och master/slave
%   förhållande.
%
%   -En beskrivning av vilken information (data, styrinformation, sensorvärden
%   etc.) som ska skickas mellan blocken, samt hur och vilken väg den ska
%   skickas. (Detaljer kring informationskodning och överföringsprotokoll kan
%   gruppen få utveckla under projektets gång).

\begin{document}

\section{Kommunikation}
TODO intro för kommuikation 
delvis mellan enhet (komm) och laptop, även mellan moduler, (inom moduler?)

\subsection{Trådlös länk}
Taxin och fjärrklienten kommer att kommunicera via TCP/IP.
Kommunikationsmodulen och fjärrklienten ansluter till ett gemensamt WLAN.
Därefter binder kommunikationsmodulen sin IP-address och en port till en sockel
som fjärrklienten kan ansluta till.

\subsubsection{Protokoll}
TODO specificera vad som ska skickas: till exempel
    "get\_data" -> komm
        komm svarar med "1.532;0.34;2344" -> laptop

    eller

    "set\_speed\_error:1.5" -> komm
        komm sätter speed\_error till 1.5

% TODO lägg till diagram som visar buss utan detaljer
\subsection{Mellan taxins moduler}
Mellan sensormodulen, kommunikationsmodulen och styrmodulen används
gränssnittet {\iic}, även känt som TWI. Varje modul är kopplad till en
SDA-signal för data och en SCL-signal för synkronisering. Kommunikationsmodulen
agerar som \emph{master} medan sensormodulen och styrmodulen agerar som
\emph{slaves}. Sensormodulen skickar sensorvärden till kommunikationsmodulen
och kommunikationsmodulen skickar styrkommandon till styrmodulen. Eventuellt
kan data överföras till sensormodulen eller från styrmodulen vid felsökning.

Ett alternativ till {\iic} är UART. Då ersätts SDA-signalen med två Tx till Rx
signaler till och från kommunikationsmodulen. Om data behöver skickas i motsatt
riktning vid felsökning behöver fler signaler läggas till och då behövs
eventuellt en extra nivåskiftare. Ett annat alternativ är SPI; detta kräver
dock fler signaler vilket inte är nödvändigt då det inte finns ett behov av
full duplex.

\subsubsection{Kommunikationsmodul till styrmodul}
Kommunikationsmodulen ska skicka ett felvärde $e_v$ för hastigheten och ett
felvärde $e_r$ för styrradien till styrmodulen med jämna mellanrum. Styrenheten
ska försöka justera hastigheten och radien som specificerat av det senaste
mottagna värdet. Figur \ref{bf:comm-ctrl} visar bitsekvensen för datan som
sänds.

\begin{figure}[H]
    \centering
    \begin{bytefield}[endianness=big]{16}
        \bitheader{0,7,8,15} \\
        \bitbox{8}{$e_v$}
        \bitbox{8}{$e_r$}
    \end{bytefield}
    \caption{Bitsekvensen för datan som skickas fortlöpande från
    kommunikationsmodulen till styrmodulen.}
    \label{bf:comm-ctrl}
\end{figure}

\paragraph{Hastighetsfelet $e_v$} består av ett signerat 8-bitars heltal i
tvåkomplementsform. Värdet är ett felvärde för hastigheten som beräknas
$e_v=v_\textit{önskad}-v_\textit{nuvarande}$. Negativa värden betyder att bilen
kör för snabbt och positiva värden betyder att farten ska öka.

\paragraph{Styrfelet $e_r$} består av ett signerat 8-bitars heltal i
tvåkomplementsform. Värdet är ett felvärde för styrradien som beräknas av
kommunikationsmodulen utifrån bilens förhållande till väglinjerna. Ett
nollvärde betyder att hjulen står rätt, negativt att hjulen bör svänga mer åt
vänster och positivt att hjulen bör svänga mer åt höger.

\subsubsection{Sensormodul till kommunikationsmodul}
Sensormodulen ska fortlöpande skicka värden för varje sensor till
kommunikationsmodulen. Figur \ref{bf:sens-comm} visar bitsekvensen som
sensormodulen skickar.

\begin{figure}[H]
    \centering
    \begin{bytefield}[endianness=big]{32}
        \bitheader{0,7,8,15,16,23,24,31} \\
        \bitbox{8}{$d_f$}
        \bitbox{8}{$d_r$}
        \bitbox{8}{$a$}
        \bitbox{8}{$n$}
    \end{bytefield}
    \caption{Bitsekvensen för datan som skickas fortlöpande till
    kommunikationsmodulen till sensormodulen.}
    \label{bf:sens-comm}
\end{figure}

\paragraph{Frontavståndet $d_f$} är ett 8-bitars osignerat heltal som
representerar avståndet från sensorn på taxins framsida. Heltalet representerar
avståndet som frontsensorn läser i centimeter.

\paragraph{Sidoavståndet $d_r$} är ett 8-bitars osignerat heltal som
representerar avståndet från sensorn på taxins högersida. Heltalet
representerar avståndet som sidosensorn läser i centimeter.

\paragraph{Ljusstyrkan $a$} är ett 8-bitars osignerat heltal som representerar
ljusstyrkan från sensorn på taxins undersida. TODO min max?

\paragraph{Varvtalet $n$} är ett 8-bitars osignerat heltal som specificerar
antalet varv som taxins hjul har rullat sen förra sändelsen.

\end{document}
