\documentclass[designspec/spec.tex]{subfiles}

% Detta avsnitt bör innehålla:
%
%   -En beskrivning av hur processorerna kommunicerar med varandra (gäller även
%   kommunikation med PC:n om Blåtand används), protokoll och master/slave
%   förhållande.
%
%   -En beskrivning av vilken information (data, styrinformation, sensorvärden
%   etc.) som ska skickas mellan blocken, samt hur och vilken väg den ska
%   skickas. (Detaljer kring informationskodning och överföringsprotokoll kan
%   gruppen få utveckla under projektets gång).

\begin{document}

\section{Kommunikation}
TODO intro för kommuikation 

\subsection{Trådlös länk}

\subsubsection{Protokoll}

\subsection{Databuss mellan moduler}
Mellan sensormodulen, kommunikationsmodulen och styrmodulen ligger en databuss
som använder \iic. Kommunikationsmodulen agerar som master medan sensormodulen
och styrmodulen agerar som slave. Sensormodulen kommer skicka sensorvärden till
kommunikationsmodulen och kommunikationsmodulen skickar styrkommandon till
styrmodulen. Eventuellt kan data överföras till sensormodulen eller från
styrmodulen vid debuggning. Med {\iic} krävs ingen extra signal för att skicka i
båda riktningar som med UART. Eftersom full duplex inte är nödvändigt behövs
inte heller någon extra signal som med SPI.

\subsubsection{Kommunikationsmodul till styrmodul}
Kommunikationsmodulen ska skicka ett felvärde $e_v$ för hastigheten och ett
felvärde $e_r$ för styrradien till styrmodulen med jämna mellanrum. Styrenheten
ska försöka justera hastigheten radien som specificerat av det senaste mottagna
värdet. Figur \ref{bf:comm-ctrl} visar bitsekvensen för datan som sänds.

\begin{figure}[H]
    \centering
    \begin{bytefield}[endianness=big]{16}
        \bitheader{0,7,8,15} \\
        \bitbox{8}{$e_v$}
        \bitbox{8}{$e_r$}
    \end{bytefield}
    \label{bf:comm-ctrl}
    \caption{Bitsekvensen för datan som skickas fortlöpande från
    kommunikationsmodulen till styrmodulen.}
\end{figure}

\paragraph{Hastighetsfelet $e_v$} består av ett signerat 8-bitars heltal i
tvåkomplementsform. Värdet är ett felvärde för hastigheten som beräknas
$e_v=v_\textit{önskad}-v_\textit{nuvarande}$. Negativa värden betyder att bilen
kör för snabbt och positiva värden betyder att farten ska öka.

\paragraph{Styrfelet $e_r$} består av ett signerat 8-bitars heltal i
tvåkomplementsform. Värdet är ett felvärde för styrradien som beräknas av
kommunikationsmodulen utifrån bilens förhållande till väglinjerna. Ett
nollvärde betyder att hjulen står rätt, negativt att hjulen bör svänga mer åt
vänster och positivt att hjulen bör svänga mer åt höger.

\subsubsection{Sensormodul till kommunikationsmodul}
Sensormodulen ska fortlöpande skicka värden för varje sensor till
kommunikationsmodulen. Fig \ref{bf:sens-comm} visar bitsekvensen som sensormodulen
skickar.

\begin{figure}[H]
    \centering
    \begin{bytefield}[endianness=big]{32}
        \bitheader{0,7,8,15,16,23,24,31} \\
        \bitbox{8}{$d_f$}
        \bitbox{8}{$d_r$}
        \bitbox{8}{$a$}
        \bitbox{8}{$n$}
    \end{bytefield}
    \label{bf:sens-comm}
    \caption{Bitsekvensen för datan som skickas fortlöpande till
    kommunikationsmodulen till sensormodulen.}
\end{figure}

\paragraph{Frontavståndet $d_f$} är ett 8-bitars osignerat heltal som
representerar avståndet från sensorn på taxins framsida. Heltalet representerar
avståndet som frontsensorn läser i centimeter.

\paragraph{Sidoavståndet $d_r$} är ett 8-bitars osignerat heltal som
representerar avståndet från sensorn på taxins högersida. Heltalet
representerar avståndet som sidosensorn läser i centimeter.

\paragraph{Ljusstyrkan $a$} är ett 8-bitars osignerat heltal som representerar
ljusstyrkan från sensorn på taxins undersida. TODO min max?

\paragraph{Varvtalet $n$} är ett 8-bitars osignerat heltal som specificerar
antalet varv som taxins hjul har rullat sen förra sändelsen.

\end{document}
