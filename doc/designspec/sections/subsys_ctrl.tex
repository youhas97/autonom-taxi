\documentclass[designspec/spec.tex]{subfiles}

\begin{document}

\section{Styrmodul}
Styrmodulen är en modul som har i uppgift att ta emot felvärden från
kommunikationsmodulen och reglera bilens drivmotor och svängmotor utifrån
dessa.

\subsection{Funktion}
Styrmodulens syfte är att hantera den direkta kontrollen av styrreglagen för
taxins motorer. Styrmodulen ska reglera drivmotorn och svängmotorn utifrån
felvärden som ges av kommunikationsmodulen.

\subsection{Hårdvaruimplementation}
Styrmodulen består av en mikrokontroller, taxins motorer samt en LCD för
felsökning. Ett detaljerat kretsschema finns i bilaga \ref{cdiag:ctrl}.

\subsubsection{Budget}
Utöver motorn och servon som redan sitter monterade på chassit behöver
styrmodulen följande komponenter.
\begin{itemize}
	\item \textbf{\modMicrocontroller} Modulens microprocessor. 
    \item \textbf{\modJtag} Debugger för programmering och felsökning med
        microprocessorn. 
    \item \textbf{\modLcd} LCD-display för att visa parametrar under körning i
        felsökningssyfte.
\end{itemize}

\subsubsection{Kontroll och bedömning}
% TODO rätt pinnar/signaler?
Nedan är följande pinnar som används på mikrokontrollern.
\begin{itemize}
   \item \textbf{PA0-PA7} Datasignaler till LCD.
   \item \textbf{PB0} RS-signal till LCD.
   \item \textbf{PB3} PWM-signal till drivmotor.
   \item \textbf{PB4-PB7} SS, MOSI, MISO och SCLK för SPI-bussen.
   \item \textbf{PC2-PC5} TCK, TMS, TDO, TDI för JTAG.
   \item \textbf{PD5} PWM-signal till svängmotor.
   \item \textbf{RESET} Resetsignal.
   \item \textbf{XTAL1} Klocka från kristalloscillatorn.
\end{itemize}
Inga fler signaler behövs så pinnarna på mikrokontrollen är tillräckliga.

Mikrokontrollern behöver endast kommunicera via bussen, utföra enkel reglering
och därefter skapa en PWM-signal för motorerna. Inget av detta är särskilt
krävande och bör klaras utan problem av ATMega1284. Kontrollern har ett
flash-minne på 128kB vilket bör vara mer än tillräckligt för att lagra
programmet.

\subsection{Mjukvaruimplementation}
Styrmodulens program kommer bestå av en main loop som reglerar bilens hastighet
efter ett felvärde. Ett avbrott som aktiveras när kommunikationsmodulen vill
kommunicera kommer att ta emot nya felvärden med jämna mellanrum.

\subsubsection{Huvud-loop}
I huvudloopen kommer värdena från kommunikationsmodulen göras om till
motsvarande tidsintervall i PWM. Beroende på hur snabbt det går så kommer
huvudloopen vänta på avbrott.

% TODO ändra till SPI:s motsvarande avbrott
%\subsubsection{Avbrott}
%\begin{itemize}
%	\item \textbf{TWI\_Interrupt} Avbrottet sker när TWI-bussen adresserar
%	styrmodulen. I avbrottet måste statusregistret TWSR maskas för att kunna
%	avgöra vilken funktion som ska utföras. T.ex. skicka/ta emot data e.t.c. 
%
%	\item \textbf{Output\_Compare\_Interrupt} Avbrottet sker när en PWM puls
%	ska skickas ut till servon eller motorn. Avbrottet sker varje gång
%	motsvarande timer-register har nått sitt maximum och startar om från noll.
%\end{itemize}

\end{document}
