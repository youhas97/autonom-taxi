\documentclass[designspec/spec.tex]{subfiles}

\begin{document}

\section{Styrmodul}
Styrmodulen är en modul som har i uppgift att ta emot felvärden från
kommunikationsmodulen och reglera bilens drivmotor och svängservo utifrån
dessa.

\subsection{Funktion}
Styrmodulens syfte är att hantera den direkta kontrollen av styrreglagen för
taxins motor. Styrmodulen ska reglera drivmotorn och svängservo utifrån
felvärden som ges av kommunikationsmodulen.

\subsection{Hårdvaruimplementation}
Styrmodulen består av en mikrokontroller, taxins motor samt en LCD för
felsökning. Ett detaljerat kretsschema finns i bilaga \ref{cdiag:ctrl}.

\subsubsection{Budget}
Utöver motorn och servon som redan sitter monterade på chassit behöver
styrmodulen följande komponenter.
\begin{itemize}
	\item \textbf{\modMicrocontroller} Modulens microprocessor. 
    \item \textbf{\modJtag} Debugger för programmering och felsökning med
        microprocessorn. 
    \item \textbf{\modLcd} LCD-display för att visa parametrar under körning i
        felsökningssyfte.
    \item \textbf{IQEXO3} Kristalloscillator på 16Mhz, skall använda som systemklocka till AVR.
    \item \textbf{Tryckknapp} Knapp används till RESET.
\end{itemize}

\subsubsection{Kontroll och bedömning}
Nedan är följande pinnar som används på mikrokontrollern.
\begin{itemize}
   \item \textbf{PA0-PA7} Datasignaler till LCD.
   \item \textbf{PB0} RS-signal till LCD.
   \item \textbf{PB3} PWM-signal till drivmotor.
   \item \textbf{PB4-PB7} SS, MOSI, MISO och SCLK för SPI-bussen.
   \item \textbf{PC2-PC5} TCK, TMS, TDO, TDI för JTAG.
   \item \textbf{PD5} PWM-signal till svängservo.
   \item \textbf{RESET} Resetsignal.
   \item \textbf{XTAL1} Klocka från kristalloscillatorn.
\end{itemize}
Inga fler signaler behövs så pinnarna på mikrokontrollen är tillräckliga.

Mikrokontrollen behöver endast kommunicera via SPI, utföra enkel reglering och
därefter skapa en PWM-signal för motorn. Inget av detta är särskilt krävande
och bör klaras utan problem av ATMega1284. Kontrollern har ett flash-minne på
128kB, vilket bör vara mer än tillräckligt för att lagra programmet.

\subsection{Mjukvaruimplementation}
Styrmodulens program kommer bestå av en main loop som reglerar bilens hastighet
efter ett felvärde. Ett avbrott som aktiveras när kommunikationsmodulen vill
kommunicera kommer att ta emot nya felvärden med jämna mellanrum.

\subsubsection{Huvud-loop}
I huvudloopen kommer värdena från kommunikationsmodulen göras om till
motsvarande tidsintervall i PWM. Beroende på hur snabbt det går så kommer
huvudloopen vänta på avbrott.

\subsubsection{Avbrott} \label{sec:ctrl-int}
När SPI-kontrollern har tagit emot en byte av data sätter den SPIF i SPSR (SPI
Status Register) och aktiverar ett avbrott. Avbrottsrutinen kan flaggan
kontrollera för att avgöra att kommunikationsmodulen vill skicka felvärden och
börja ta emot värden.

\end{document}
